---
import { getEvents, getDirectusUrl, type Event } from '../lib/directus';
import calendarPlaceholder from '../assets/images/calendar-btc.png';
import StateIndicator from './StateIndicator.astro';

interface Props {
  class?: string;
  showStateIndicator?: boolean;
}

const { class: className = '', showStateIndicator = true } = Astro.props;

const result = await getEvents();
const allEvents = result.data || [];

// Filter to only show future events
const now = new Date();
const events = allEvents.filter(event => {
  const endDate = event.end_date_time ? new Date(event.end_date_time) : new Date(event.start_date_time);
  return endDate > now;
});

// Format date and time
function formatEventDate(startDate: string, endDate?: string | null): string {
  const start = new Date(startDate);
  const end = endDate ? new Date(endDate) : null;

  const options: Intl.DateTimeFormatOptions = {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  };

  const dateStr = start.toLocaleDateString('en-US', options);

  const timeOptions: Intl.DateTimeFormatOptions = {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
  };

  const startTime = start.toLocaleTimeString('en-US', timeOptions);
  
  if (end) {
    const endTime = end.toLocaleTimeString('en-US', timeOptions);
    return `${dateStr} • ${startTime} - ${endTime}`;
  }

  return `${dateStr} • ${startTime}`;
}

// Get event image URL
function getEventImageUrl(event: Event): string {
  if (!event.image) return calendarPlaceholder.src;
  
  const directusUrl = getDirectusUrl();
  if (typeof event.image === 'string') {
    return `${directusUrl}/assets/${event.image}`;
  }
  return `${directusUrl}/assets/${event.image.id}`;
}

// Extract first line of description
function getFirstLine(html: string): string {
  // Strip HTML tags
  const text = html.replace(/<[^>]*>/g, '');
  // Get first line or first sentence
  const firstLine = text.split(/\n|\.(?=\s|$)/)[0];
  return firstLine.trim();
}

// Check if description has multiple lines/sentences
function hasMoreContent(html: string): boolean {
  const text = html.replace(/<[^>]*>/g, '').trim();
  const lines = text.split(/\n/);
  return lines.length > 1 || text.split(/\.(?=\s|$)/).length > 1;
}
---

<div class={`events-list ${className}`}>
  {events.length === 0 ? (
    <div class="no-events">
      <p>No upcoming events at this time. Check back soon!</p>
    </div>
  ) : (
    <div class="events-stack">
      {events.map((event) => {
        const firstLine = getFirstLine(event.description);
        const hasMore = hasMoreContent(event.description);
        const rsvpUrl = event.rsvp_url || '#';
        const imageUrl = getEventImageUrl(event);
        
        return (
          <div class="event-card" data-event-id={event.id}>
            <a 
              href={rsvpUrl}
              class="event-image-link"
              target={rsvpUrl !== '#' ? '_blank' : undefined}
              rel={rsvpUrl !== '#' ? 'noopener noreferrer' : undefined}
              aria-label={`View ${event.title}`}
            >
              <div class="event-image">
                <img src={imageUrl} alt={event.title} class="event-list-image" />
                <StateIndicator sourceFeed={event.source_feed} enabled={showStateIndicator} />
              </div>
            </a>

            <div class="event-content">
              <div class="event-header">
                <h3 class="event-title">{event.title}</h3>
                <p class="event-date">{formatEventDate(event.start_date_time, event.end_date_time)}</p>
              </div>

              <div class="event-description">
                <p class="description-preview">{firstLine}</p>
                {hasMore && (
                  <div class="description-full" style="display: none;">
                    <div set:html={event.description} />
                  </div>
                )}
              </div>

              <div class="event-actions">
                {hasMore && (
                  <button class="expand-btn" data-expanded="false">
                    <span class="expand-text">Read more</span>
                    <svg class="expand-icon" width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                )}
                <a href={rsvpUrl} class="rsvp-btn" target={rsvpUrl !== '#' ? '_blank' : undefined} rel={rsvpUrl !== '#' ? 'noopener noreferrer' : undefined}>
                  RSVP →
                </a>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  )}
</div>

<style>
  .events-list {
    width: 100%;
  }

  .no-events {
    text-align: center;
    padding: 3rem 2rem;
    color: #6b7280;
    font-size: 1.125rem;
  }

  .events-stack {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .event-card {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 1.25rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.2s ease;
  }

  .event-card:hover {
    border-color: #f7931a;
    box-shadow: 0 2px 8px rgba(247, 147, 26, 0.12);
  }

  .event-image-link {
    display: block;
    width: 200px;
    flex-shrink: 0;
    text-decoration: none;
  }

  .event-image {
    width: 100%;
    aspect-ratio: 1 / 1;
    overflow: hidden;
    background: #f3f4f6;
    position: relative;
  }

  .event-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: opacity 0.2s ease;
  }

  .event-image-link:hover img {
    opacity: 0.9;
  }

  .event-content {
    padding: 1.25rem 1.25rem 1.25rem 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .event-header {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .event-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    margin: 0;
    line-height: 1.3;
  }

  .event-date {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0;
    font-weight: 500;
  }

  .event-description {
    color: #4b5563;
    line-height: 1.5;
    font-size: 0.9375rem;
  }

  .description-preview {
    margin: 0;
  }

  .description-full {
    margin-top: 0.5rem;
    color: #4b5563;
  }

  .description-full :global(p) {
    margin: 0.5rem 0;
  }

  .description-full :global(p:first-child) {
    margin-top: 0;
  }

  .description-full :global(p:last-child) {
    margin-bottom: 0;
  }

  .event-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-top: auto;
  }

  .expand-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    background: none;
    border: none;
    color: #f7931a;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    padding: 0;
    transition: all 0.2s ease;
  }

  .expand-btn:hover {
    color: #d97706;
  }

  .expand-icon {
    transition: transform 0.3s ease;
  }

  .expand-btn[data-expanded="true"] .expand-icon {
    transform: rotate(180deg);
  }

  .rsvp-btn {
    display: inline-block;
    padding: 0.5rem 1.25rem;
    background-color: #f7931a;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.2s ease;
    border: 2px solid #f7931a;
  }

  .rsvp-btn:hover {
    background-color: #d97706;
    border-color: #d97706;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(247, 147, 26, 0.3);
  }

  @media (max-width: 768px) {
    .event-card {
      grid-template-columns: 1fr;
      gap: 0;
    }

    .event-image-link {
      display: none;
    }

    .event-content {
      padding: 1.25rem;
    }

    .event-title {
      font-size: 1.125rem;
    }

    .event-date {
      font-size: 0.8125rem;
    }

    .event-actions {
      flex-direction: column;
      align-items: stretch;
      gap: 0.75rem;
    }

    .rsvp-btn {
      text-align: center;
    }
  }
</style>

<script>
  // Handle expand/collapse functionality
  document.addEventListener('DOMContentLoaded', () => {
    const expandButtons = document.querySelectorAll('.expand-btn');

    expandButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const card = button.closest('.event-card');
        if (!card) return;

        const preview = card.querySelector('.description-preview');
        const full = card.querySelector('.description-full');
        const expandText = button.querySelector('.expand-text');
        const isExpanded = button.getAttribute('data-expanded') === 'true';

        if (isExpanded) {
          // Collapse
          button.setAttribute('data-expanded', 'false');
          if (preview) (preview as HTMLElement).style.display = 'block';
          if (full) (full as HTMLElement).style.display = 'none';
          if (expandText) expandText.textContent = 'Read more';
        } else {
          // Expand
          button.setAttribute('data-expanded', 'true');
          if (preview) (preview as HTMLElement).style.display = 'none';
          if (full) (full as HTMLElement).style.display = 'block';
          if (expandText) expandText.textContent = 'Read less';
        }
      });
    });
  });
</script>
