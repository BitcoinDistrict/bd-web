---
import { siteConfig, type SEOConfig } from "../config/site";
import NostrIcon from "../components/icons/Nostr.astro";
import Footer from "../components/Footer.astro";
import caporangeLogo from "../assets/images/caporange.png";
import "../styles/theme.css";

interface Props {
  seo?: SEOConfig;
}

const { seo } = Astro.props as Props;

const title = seo?.title ?? siteConfig.seo.defaultTitle;
const description = seo?.description ?? siteConfig.seo.defaultDescription;
const ogType = seo?.type ?? "website";
const ogImage = seo?.image;
const noindex = seo?.noindex ?? false;

// Generate canonical URL
const currentUrl = new URL(Astro.url.pathname, siteConfig.siteUrl);
const canonical = seo?.canonical 
  ? (seo.canonical.startsWith('http') ? seo.canonical : new URL(seo.canonical, siteConfig.siteUrl).href)
  : currentUrl.href;

// Use siteConfig directly (no CMS navigation/globals collections)
const siteTitle = siteConfig.title;
const siteUrl = siteConfig.siteUrl;
const xUrl = siteConfig.socialLinks[0].href;
const nostrUrl = siteConfig.socialLinks[1].href;
const githubUrl = siteConfig.socialLinks[2].href;
const mainNavItems = siteConfig.nav.main;
const footerNavItems = siteConfig.nav.footer;

// Generate structured data
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": `${siteUrl}/#organization`,
      "name": siteTitle,
      "url": siteUrl,
      "sameAs": [
        xUrl,
        nostrUrl,
        githubUrl,
      ].filter(Boolean),
    },
    {
      "@type": "WebSite",
      "@id": `${siteUrl}/#website`,
      "url": siteUrl,
      "name": siteTitle,
      "publisher": {
        "@id": `${siteUrl}/#organization`,
      },
    },
  ],
};
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"
    />
    
    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    {seo?.author && <meta name="author" content={seo.author} />}
    <meta name="robots" content={noindex ? "noindex, nofollow" : "index, follow"} />
    
    <!-- Canonical URL -->
    <link rel="canonical" href={canonical} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:site_name" content={siteTitle} />
    {ogImage && <meta property="og:image" content={ogImage.startsWith('http') ? ogImage : new URL(ogImage, siteUrl).href} />}
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImage && <meta name="twitter:image" content={ogImage.startsWith('http') ? ogImage : new URL(ogImage, siteUrl).href} />}
    
    <!-- Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  </head>
  <body>
    <nav>
      <div class="nav-container">
        <div class="nav-left">
          <a href="/" class="site-branding">
            <img src={caporangeLogo.src} alt="Bitcoin District Logo" class="site-logo" />
            <strong>{siteTitle}</strong>
          </a>
        </div>
        
        <ul class="nav-center">
          {mainNavItems.map((navItem: any) => (
            <li>
              {navItem.children ? (
                <div class="dropdown">
                  {navItem.href ? (
                    <a href={navItem.href} class="dropdown-title">{navItem.label}</a>
                  ) : (
                    <span class="dropdown-title">{navItem.label}</span>
                  )}
                  <ul class="dropdown-menu">
                    {navItem.children?.map((child: any) => (
                      <li>
                        <a href={child.href}>{child.label}</a>
                      </li>
                    ))}
                  </ul>
                </div>
              ) : (
                <a href={navItem.href}>{navItem.label}</a>
              )}
            </li>
          ))}
        </ul>
        
        <div class="nav-right">
          <div class="social-links">
            {xUrl && (
              <a href={xUrl} target="_blank" rel="noopener noreferrer" aria-label="X (Twitter)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
              </a>
            )}
            {nostrUrl && (
              <a href={nostrUrl} target="_blank" rel="noopener noreferrer" aria-label="Nostr">
                <NostrIcon width="20" height="20" class="" />
              </a>
            )}
            {githubUrl && (
              <a href={githubUrl} target="_blank" rel="noopener noreferrer" aria-label="Github">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/>
                </svg>
              </a>
            )}
          </div>
        </div>

        <!-- Mobile hamburger button -->
        <button class="mobile-menu-button" aria-label="Toggle menu" aria-expanded="false">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
      </div>

      <!-- Mobile menu overlay -->
      <div class="mobile-menu">
        <ul class="mobile-nav-links">
          {mainNavItems.map((navItem: any) => (
            <li>
              {navItem.children ? (
                <div class={`mobile-dropdown ${navItem.label === 'Events' ? 'active auto-expanded' : ''}`}>
                  {navItem.href ? (
                    <a href={navItem.href} class="mobile-dropdown-title">{navItem.label}</a>
                  ) : (
                    <span class="mobile-dropdown-title">{navItem.label}</span>
                  )}
                  <ul class="mobile-dropdown-menu">
                    {navItem.children?.map((child: any) => (
                      <li>
                        <a href={child.href}>{child.label}</a>
                      </li>
                    ))}
                  </ul>
                </div>
              ) : (
                <a href={navItem.href}>{navItem.label}</a>
              )}
            </li>
          ))}
        </ul>
        
        <div class="mobile-social-links">
          {xUrl && (
            <a href={xUrl} target="_blank" rel="noopener noreferrer" aria-label="X (Twitter)">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </a>
          )}
          {nostrUrl && (
            <a href={nostrUrl} target="_blank" rel="noopener noreferrer" aria-label="Nostr">
              <NostrIcon width="20" height="20" class="" />
            </a>
          )}
          {githubUrl && (
            <a href={githubUrl} target="_blank" rel="noopener noreferrer" aria-label="Github">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/>
              </svg>
            </a>
          )}
        </div>
      </div>
    </nav>

    <script>
      // Mobile menu toggle functionality
      const mobileMenuButton = document.querySelector('.mobile-menu-button');
      const mobileMenu = document.querySelector('.mobile-menu');
      const body = document.body;

      if (mobileMenuButton && mobileMenu) {
        mobileMenuButton.addEventListener('click', () => {
          const isOpen = mobileMenu.classList.contains('active');
          
          if (isOpen) {
            mobileMenu.classList.remove('active');
            mobileMenuButton.classList.remove('active');
            mobileMenuButton.setAttribute('aria-expanded', 'false');
            body.style.overflow = '';
          } else {
            mobileMenu.classList.add('active');
            mobileMenuButton.classList.add('active');
            mobileMenuButton.setAttribute('aria-expanded', 'true');
            body.style.overflow = 'hidden';
          }
        });

        // Close menu when clicking on a link
        const mobileNavLinks = mobileMenu.querySelectorAll('a');
        mobileNavLinks.forEach(link => {
          link.addEventListener('click', () => {
            mobileMenu.classList.remove('active');
            mobileMenuButton.classList.remove('active');
            mobileMenuButton.setAttribute('aria-expanded', 'false');
            body.style.overflow = '';
          });
        });

        // Handle mobile dropdown toggles (skip auto-expanded ones)
        const mobileDropdownTitles = mobileMenu.querySelectorAll('.mobile-dropdown-title');
        mobileDropdownTitles.forEach(title => {
          const dropdown = title.closest('.mobile-dropdown');
          // Skip auto-expanded dropdowns
          if (!title.getAttribute('href') && !dropdown?.classList.contains('auto-expanded')) {
            title.addEventListener('click', (e) => {
              dropdown?.classList.toggle('active');
            });
          }
        });
      }
    </script>

    <div class="page-content">
      <slot />
    </div>

    <Footer />
  </body>
</html>
