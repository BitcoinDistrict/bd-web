---
import Layout from "../layouts/Layout.astro";
import PageHeader from "../components/PageHeader.astro";
import { getBooks, getDirectusUrl, type Book } from "../lib/directus";

// Prevent caching to ensure fresh data from Directus
Astro.response.headers.set('Cache-Control', 'no-cache, must-revalidate');

const cmsEnabled = import.meta.env.PUBLIC_CMS_ENABLED === "true";

let books: Book[] = [];
let error: string | null = null;

if (cmsEnabled) {
  const result = await getBooks();
  if (result.error) {
    error = result.error;
    console.error("[Book Club Page] Error fetching books:", result.error);
  } else {
    books = result.data || [];
    console.log(`[Book Club Page] Loaded ${books.length} book(s)`);
  }
} else {
  console.warn("[Book Club Page] CMS is disabled");
}

const directusUrl = getDirectusUrl();

// Helper function to get image URL
function getBookImageUrl(coverImage: Book['cover_image']): string | null {
  if (!coverImage) return null;
  if (typeof coverImage === 'string') {
    return `${directusUrl}/assets/${coverImage}`;
  }
  return `${directusUrl}/assets/${coverImage.id}`;
}

// Separate books by date
const today = new Date();
today.setHours(0, 0, 0, 0);

const booksWithDates = books.filter(book => book.date_bookclub_read);
const booksWithoutDates = books.filter(book => !book.date_bookclub_read);

// Find the featured book (next upcoming or most recent)
const futureBooks = booksWithDates.filter(book => {
  const bookDate = new Date(book.date_bookclub_read!);
  return bookDate >= today;
}).sort((a, b) => new Date(a.date_bookclub_read!).getTime() - new Date(b.date_bookclub_read!).getTime());

const pastBooks = booksWithDates.filter(book => {
  const bookDate = new Date(book.date_bookclub_read!);
  return bookDate < today;
}).sort((a, b) => new Date(b.date_bookclub_read!).getTime() - new Date(a.date_bookclub_read!).getTime());

const featuredBook = futureBooks[0] || pastBooks[0] || booksWithoutDates[0];

// Create list of all books for the table (excluding featured)
const tableBooks = books.filter(book => book.id !== featuredBook?.id);

// Sort table books: future dates first (ascending), then past dates (descending), then undated
const sortedTableBooks = [
  ...futureBooks.filter(book => book.id !== featuredBook?.id),
  ...pastBooks,
  ...booksWithoutDates
];

// Format date helper
function formatDate(dateStr: string | null | undefined): string {
  if (!dateStr) return 'TBD';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
}

const seo = {
  title: "Book Club | Bitcoin District",
  description: "Join our Bitcoin book club and explore literature about Bitcoin, economics, and freedom.",
};
---

<Layout seo={seo}>
  <main class="bookclub-page">
    <PageHeader 
      title="Bitcoin District Book Club"
      description="We gather monthly to discuss books on Bitcoin, money, economics, and freedom. Everyone is welcome!"
      size="large"
    />

    {error ? (
      <section class="error-message" aria-live="polite">
        <p>
          {error === "NOT_FOUND" 
            ? "No books found." 
            : "Unable to load books at this time. Please try again later."}
        </p>
      </section>
    ) : books.length === 0 ? (
      <section class="empty-state">
        <p>No books have been added yet. Check back soon!</p>
      </section>
    ) : (
      <>
        {featuredBook && (
          <section class="featured-book" aria-labelledby="featured-book-title">
            <div class="featured-content">
              <div class="featured-image">
                {getBookImageUrl(featuredBook.cover_image) ? (
                  <img 
                    src={getBookImageUrl(featuredBook.cover_image)!} 
                    alt={`Cover of ${featuredBook.title}`}
                    loading="eager"
                  />
                ) : (
                  <div class="placeholder-image">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                    </svg>
                  </div>
                )}
              </div>
              <div class="featured-info">
                <div class="featured-label">
                  {futureBooks.includes(featuredBook) ? 'Next Book' : 'Most Recent'}
                </div>
                <h2 id="featured-book-title">{featuredBook.title}</h2>
                <p class="author">by {featuredBook.author}</p>
                <p class="date">{formatDate(featuredBook.date_bookclub_read)}</p>
                {featuredBook.purchase_url && (
                  <a href={featuredBook.purchase_url} target="_blank" rel="noopener noreferrer" class="purchase-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                    </svg>
                    Get this book
                  </a>
                )}
              </div>
            </div>
          </section>
        )}

        {sortedTableBooks.length > 0 && (
          <section class="books-list" aria-labelledby="books-list-title">
            <h2 id="books-list-title">Our Reading List</h2>
            
            <div class="table-container">
              <table id="books-table">
                <thead>
                  <tr>
                    <th class="sortable" data-column="title">
                      <button type="button">
                        Title
                        <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 15l5 5 5-5M7 9l5-5 5 5"/>
                        </svg>
                      </button>
                    </th>
                    <th class="sortable" data-column="author">
                      <button type="button">
                        Author
                        <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 15l5 5 5-5M7 9l5-5 5 5"/>
                        </svg>
                      </button>
                    </th>
                    <th class="sortable" data-column="date">
                      <button type="button">
                        Date Read
                        <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 15l5 5 5-5M7 9l5-5 5 5"/>
                        </svg>
                      </button>
                    </th>
                    <th>ðŸ›’</th>
                  </tr>
                </thead>
                <tbody>
                  {sortedTableBooks.map((book) => (
                    <tr data-title={book.title} data-author={book.author} data-date={book.date_bookclub_read || ''}>
                      <td class="book-title">
                        {getBookImageUrl(book.cover_image) && (
                          <img 
                            src={getBookImageUrl(book.cover_image)!} 
                            alt="" 
                            class="book-thumbnail"
                            loading="lazy"
                          />
                        )}
                        <span>{book.title}</span>
                      </td>
                      <td>{book.author}</td>
                      <td class="date-cell">{formatDate(book.date_bookclub_read)}</td>
                      <td>
                        {book.purchase_url && (
                          <a href={book.purchase_url} target="_blank" rel="noopener noreferrer" class="purchase-link" aria-label={`Purchase ${book.title}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
                              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
                            </svg>
                          </a>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </section>
        )}
      </>
    )}
  </main>
</Layout>

<script>
  // Table sorting functionality
  let currentSort: { column: string; direction: 'asc' | 'desc' } = { column: '', direction: 'asc' };

  function sortTable(column: string) {
    const table = document.getElementById('books-table');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle direction if same column, otherwise default to ascending
    if (currentSort.column === column) {
      currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
      currentSort.column = column;
      currentSort.direction = 'asc';
    }

    rows.sort((a, b) => {
      let aVal: string | number = '';
      let bVal: string | number = '';

      if (column === 'date') {
        aVal = a.dataset.date || '';
        bVal = b.dataset.date || '';
        
        // Handle TBD dates (empty strings go to end)
        if (!aVal && !bVal) return 0;
        if (!aVal) return 1;
        if (!bVal) return -1;
        
        const aTime = new Date(aVal).getTime();
        const bTime = new Date(bVal).getTime();
        return currentSort.direction === 'asc' ? aTime - bTime : bTime - aTime;
      } else if (column === 'title') {
        aVal = (a.dataset.title || '').toLowerCase();
        bVal = (b.dataset.title || '').toLowerCase();
      } else if (column === 'author') {
        aVal = (a.dataset.author || '').toLowerCase();
        bVal = (b.dataset.author || '').toLowerCase();
      }

      if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
      return 0;
    });

    rows.forEach(row => tbody.appendChild(row));
    updateSortIndicators();
  }

  function updateSortIndicators() {
    const headers = document.querySelectorAll('.sortable');
    headers.forEach(header => {
      const headerElement = header as HTMLElement;
      const button = headerElement.querySelector('button');
      const icon = headerElement.querySelector('.sort-icon');
      const column = headerElement.dataset.column;
      
      if (!button || !icon) return;

      if (column === currentSort.column) {
        button.classList.add('active');
        icon.classList.add(currentSort.direction === 'asc' ? 'asc' : 'desc');
        icon.classList.remove(currentSort.direction === 'asc' ? 'desc' : 'asc');
      } else {
        button.classList.remove('active');
        icon.classList.remove('asc', 'desc');
      }
    });
  }

  // Initialize event listeners
  document.addEventListener('DOMContentLoaded', () => {
    const sortableHeaders = document.querySelectorAll('.sortable button');
    sortableHeaders.forEach(button => {
      button.addEventListener('click', () => {
        const header = button.closest('.sortable') as HTMLElement | null;
        const column = header?.dataset.column;
        if (column) sortTable(column);
      });
    });
  });

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:after-swap', () => {
    const sortableHeaders = document.querySelectorAll('.sortable button');
    sortableHeaders.forEach(button => {
      button.addEventListener('click', () => {
        const header = button.closest('.sortable') as HTMLElement | null;
        const column = header?.dataset.column;
        if (column) sortTable(column);
      });
    });
  });
</script>

<style>
  .bookclub-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 3rem 2rem;
  }

  .featured-book {
    background: linear-gradient(135deg, #f7931a 0%, #ffa726 100%);
    border-radius: 1rem;
    padding: 3rem;
    margin-bottom: 4rem;
    box-shadow: 0 10px 40px rgba(247, 147, 26, 0.2);
  }

  .featured-content {
    display: flex;
    gap: 3rem;
    align-items: center;
  }

  .featured-image {
    flex-shrink: 0;
    width: 200px;
  }

  .featured-image img {
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .placeholder-image {
    width: 200px;
    height: 300px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.6);
  }

  .featured-info {
    flex: 1;
    color: white;
  }

  .featured-label {
    display: inline-block;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.4rem 1rem;
    border-radius: 2rem;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
  }

  .featured-info h2 {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    line-height: 1.2;
  }

  .featured-info .author {
    font-size: 1.3rem;
    margin: 0 0 0.5rem 0;
    opacity: 0.95;
  }

  .featured-info .date {
    font-size: 1.1rem;
    margin: 0 0 1.5rem 0;
    opacity: 0.85;
  }

  .purchase-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: white;
    color: #f7931a;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    text-decoration: none;
    font-weight: 600;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .purchase-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  }

  .books-list {
    margin-top: 3rem;
  }

  .books-list h2 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 1.5rem 0;
    color: #111;
  }

  .table-container {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    overflow: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead {
    background: #f8f9fa;
    border-bottom: 2px solid #e9ecef;
  }

  th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  th.sortable button {
    background: none;
    border: none;
    padding: 0;
    font: inherit;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: inherit;
    transition: color 0.2s;
  }

  th.sortable button:hover {
    color: #f7931a;
  }

  th.sortable button.active {
    color: #f7931a;
  }

  .sort-icon {
    opacity: 0.3;
    transition: opacity 0.2s, transform 0.2s;
  }

  th.sortable button:hover .sort-icon {
    opacity: 0.6;
  }

  th.sortable button.active .sort-icon {
    opacity: 1;
  }

  .sort-icon.asc {
    transform: rotate(180deg);
  }

  tbody tr {
    border-bottom: 1px solid #f1f3f5;
    transition: background-color 0.2s;
  }

  tbody tr:hover {
    background-color: #f8f9fa;
  }

  td {
    padding: 1rem;
    color: #495057;
  }

  .book-title {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-weight: 500;
    color: #212529;
  }

  .book-thumbnail {
    width: 40px;
    height: 60px;
    object-fit: cover;
    border-radius: 0.25rem;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  .date-cell {
    color: #6c757d;
  }

  .purchase-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    color: #f7931a;
    border-radius: 0.375rem;
    transition: background-color 0.2s, transform 0.2s;
  }

  .purchase-link:hover {
    background-color: #fff3e0;
    transform: scale(1.1);
  }

  .error-message,
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
    font-size: 1.1rem;
  }

  @media (max-width: 768px) {
    .bookclub-page {
      padding: 2rem 1rem;
    }

    .featured-book {
      padding: 2rem 1.5rem;
    }

    .featured-content {
      flex-direction: column;
      text-align: center;
      gap: 2rem;
    }

    .featured-image {
      width: 160px;
    }

    .placeholder-image {
      width: 160px;
      height: 240px;
    }

    .featured-info h2 {
      font-size: 1.6rem;
    }

    .featured-info .author {
      font-size: 1.1rem;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      min-width: 600px;
    }

    th, td {
      padding: 0.75rem;
      font-size: 0.9rem;
    }

    .book-thumbnail {
      width: 30px;
      height: 45px;
    }
  }
</style>
