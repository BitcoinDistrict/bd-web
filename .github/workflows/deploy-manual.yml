name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - develop
      rebuild:
        description: 'Force rebuild Docker images'
        required: false
        default: true
        type: boolean

env:
  DEPLOY_USER: deploy
  DEPLOY_HOST: ${{ secrets.PRODUCTION_HOST }}
  DEPLOY_PATH: /home/deploy/bd-web

jobs:
  deploy:
    name: Manual Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Display deployment information
        run: |
          echo "ðŸš€ Manual Deployment Triggered"
          echo "================================"
          echo "Branch: ${{ github.event.inputs.branch }}"
          echo "Rebuild: ${{ github.event.inputs.rebuild }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "================================"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: Create production .env file
        run: |
          cat > .env << EOF
          # PostgreSQL Configuration
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          
          # Directus Configuration
          DIRECTUS_KEY=${{ secrets.DIRECTUS_KEY }}
          DIRECTUS_SECRET=${{ secrets.DIRECTUS_SECRET }}
          DIRECTUS_ADMIN_EMAIL=${{ secrets.DIRECTUS_ADMIN_EMAIL }}
          DIRECTUS_ADMIN_PASSWORD=${{ secrets.DIRECTUS_ADMIN_PASSWORD }}
          
          # Public URLs
          PUBLIC_DIRECTUS_URL=https://staging.bitcoindistrict.org/admin
          
          # CMS Enable/Disable
          PUBLIC_CMS_ENABLED=true
          
          # Directus Tokens
          DIRECTUS_STATIC_TOKEN=${{ secrets.DIRECTUS_STATIC_TOKEN }}
          DIRECTUS_EVENTS_TOKEN=${{ secrets.DIRECTUS_EVENTS_TOKEN }}
          EOF

      - name: Backup current deployment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
          set -e
          cd ${{ env.DEPLOY_PATH }}
          
          if [ -f docker-compose.prod.yml ]; then
            echo "Creating backup of current deployment..."
            BACKUP_DIR="$HOME/backups/$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            
            # Backup current git state
            git rev-parse HEAD > "$BACKUP_DIR/commit.txt" 2>/dev/null || echo "unknown" > "$BACKUP_DIR/commit.txt"
            
            # Backup .env file
            cp .env "$BACKUP_DIR/.env" 2>/dev/null || true
            
            echo "Backup created at: $BACKUP_DIR"
            
            # Keep only last 5 backups
            cd "$HOME/backups"
            ls -t | tail -n +6 | xargs -r rm -rf
          else
            echo "No existing deployment to backup"
          fi
          ENDSSH

      - name: Sync files to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude 'directus/data' \
            --exclude 'directus/extensions' \
            --exclude 'directus/uploads' \
            --exclude '.cursor' \
            --exclude 'site/node_modules' \
            --exclude 'site/dist' \
            ./ ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Copy .env file to server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            .env ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/.env

      - name: Validate and deploy Caddyfile
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
          set -e
          cd ${{ env.DEPLOY_PATH }}
          
          echo "Ensuring Caddy log directory exists..."
          sudo mkdir -p /var/log/caddy
          sudo chown caddy:caddy /var/log/caddy
          sudo chmod 755 /var/log/caddy
          
          echo "Validating Caddyfile syntax..."
          sudo caddy validate --config ./Caddyfile || {
            echo "âŒ Caddyfile validation failed!"
            exit 1
          }
          
          echo "Copying validated Caddyfile to system location..."
          sudo cp ./Caddyfile /etc/caddy/Caddyfile
          sudo chown root:root /etc/caddy/Caddyfile
          sudo chmod 644 /etc/caddy/Caddyfile
          ENDSSH

      - name: Deploy with Docker Compose (Rebuild)
        if: github.event.inputs.rebuild == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
          set -e
          cd ${{ env.DEPLOY_PATH }}
          
          echo "Pulling latest Docker images..."
          docker compose -f docker-compose.prod.yml pull
          
          echo "Building and restarting containers (forced rebuild)..."
          docker compose -f docker-compose.prod.yml up -d --build --remove-orphans --force-recreate
          
          echo "Waiting for services to be healthy..."
          sleep 15
          
          echo "Checking container status..."
          docker compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: Deploy with Docker Compose (No Rebuild)
        if: github.event.inputs.rebuild == 'false'
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
          set -e
          cd ${{ env.DEPLOY_PATH }}
          
          echo "Restarting containers (no rebuild)..."
          docker compose -f docker-compose.prod.yml up -d --remove-orphans
          
          echo "Waiting for services to be healthy..."
          sleep 15
          
          echo "Checking container status..."
          docker compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: Reload Caddy
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
          set -e
          
          echo "Reloading Caddy service..."
          if sudo systemctl reload caddy; then
            echo "âœ… Caddy reloaded successfully"
          elif sudo systemctl restart caddy; then
            echo "âœ… Caddy restarted successfully"
          else
            echo "âŒ Caddy reload/restart failed"
            echo ""
            echo "=== Caddy Status ==="
            sudo systemctl status caddy --no-pager || true
            echo ""
            echo "=== Caddy Logs ==="
            sudo journalctl -xeu caddy.service --no-pager -n 50 || true
            exit 1
          fi
          ENDSSH

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
          set -e
          cd ${{ env.DEPLOY_PATH }}
          
          echo "=== Container Status ==="
          docker compose -f docker-compose.prod.yml ps
          
          echo ""
          echo "=== Disk Usage ==="
          df -h /mnt/data
          
          echo ""
          echo "=== Caddy Status ==="
          sudo systemctl status caddy --no-pager || true
          
          echo ""
          echo "=== Recent Logs ==="
          docker compose -f docker-compose.prod.yml logs --tail=30
          ENDSSH

      - name: Health check
        run: |
          echo "Waiting for services to be ready..."
          sleep 20
          
          echo "Testing main site..."
          curl -f -k https://staging.bitcoindistrict.org/ || echo "Main site not responding yet"
          
          echo "Testing admin panel..."
          curl -f -k https://staging.bitcoindistrict.org/admin || echo "Admin panel not responding yet"

      - name: Clean up
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f .env

      - name: Deployment summary
        if: success()
        run: |
          echo "âœ… Manual deployment completed successfully!"
          echo "================================"
          echo "ðŸŒ Main site: https://staging.bitcoindistrict.org"
          echo "âš™ï¸  Admin panel: https://staging.bitcoindistrict.org/admin"
          echo "ðŸ“ Branch: ${{ github.event.inputs.branch }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ðŸ”§ Rebuild: ${{ github.event.inputs.rebuild }}"
          echo "================================"

      - name: Rollback instructions
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "================================"
          echo "To rollback, run this manually:"
          echo "ssh deploy@${{ secrets.PRODUCTION_HOST }}"
          echo "cd ${{ env.DEPLOY_PATH }}"
          echo "cat ~/backups/\$(ls -t ~/backups | head -1)/commit.txt"
          echo "git checkout <commit-from-above>"
          echo "docker compose -f docker-compose.prod.yml up -d --build"
          echo "================================"
          exit 1
