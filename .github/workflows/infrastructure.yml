name: Update Infrastructure

on:
  workflow_dispatch:
    inputs:
      roles:
        description: 'Roles to run (comma-separated, or "all" for all roles)'
        required: false
        default: 'all'
        type: string
      skip_check_mode:
        description: 'Skip check mode (dry-run)'
        required: false
        default: false
        type: boolean

env:
  DEPLOY_USER: deploy
  DEPLOY_HOST: ${{ secrets.PRODUCTION_HOST }}
  DEPLOY_PATH: /home/deploy/bd-web

jobs:
  infrastructure:
    name: Update Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
          
          # SSH config for Ansible
          cat >> ~/.ssh/config << EOF
          Host ${{ secrets.PRODUCTION_HOST }}
            HostName ${{ secrets.PRODUCTION_HOST }}
            User deploy
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Cache Ansible installation
        uses: actions/cache@v4
        with:
          path: ~/.local/lib/python3.*/site-packages/ansible*
          key: ansible-${{ runner.os }}-v1
          restore-keys: |
            ansible-${{ runner.os }}-

      - name: Install Ansible
        run: |
          python3 -m pip install --upgrade pip
          pip install ansible ansible-lint

      - name: Validate Ansible syntax
        run: |
          cd ansible
          echo "üîç Validating Ansible syntax..."
          ansible-playbook --syntax-check -i inventory/production.yml playbooks/initial-setup.yml || {
            echo "‚ùå Ansible syntax validation failed!"
            exit 1
          }
          echo "‚úÖ Ansible syntax is valid"

      - name: Test sudo access
        id: test_sudo
        run: |
          echo "üîç Testing sudo access for deploy user..."
          if ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} \
            "sudo -n true" 2>/dev/null; then
            echo "‚úÖ Passwordless sudo is configured"
            echo "sudo_works=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Passwordless sudo not configured for deploy user"
            echo "sudo_works=false" >> $GITHUB_OUTPUT
            echo ""
            echo "To fix this, SSH into the server as root and run:"
            echo "  echo 'deploy ALL=(ALL) NOPASSWD: ALL' | sudo tee /etc/sudoers.d/deploy"
            echo "  sudo chmod 0440 /etc/sudoers.d/deploy"
            echo ""
            echo "Or run the deploy-user role manually with root access first."
          fi

      - name: Run Ansible in check mode (dry-run)
        if: |
          inputs.skip_check_mode == false &&
          steps.test_sudo.outputs.sudo_works == 'true'
        env:
          BD_WEB_HOST: ${{ secrets.PRODUCTION_HOST }}
          ANSIBLE_HOST_KEY_CHECKING: False
        run: |
          cd ansible
          echo "üîç Running Ansible in check mode (dry-run)..."
          
          ROLES="${{ inputs.roles }}"
          if [ "$ROLES" = "all" ] || [ -z "$ROLES" ]; then
            ansible-playbook -i inventory/production.yml playbooks/initial-setup.yml \
              -e "ansible_user=deploy" \
              --become \
              --check \
              --diff \
              -v
          else
            ansible-playbook -i inventory/production.yml playbooks/initial-setup.yml \
              --tags "$ROLES" \
              -e "ansible_user=deploy" \
              --become \
              --check \
              --diff \
              -v
          fi
          echo "‚úÖ Check mode completed - no errors detected"

      - name: Skip check mode (sudo not configured)
        if: |
          inputs.skip_check_mode == false &&
          steps.test_sudo.outputs.sudo_works == 'false'
        run: |
          echo "‚ö†Ô∏è  Skipping check mode - passwordless sudo not configured"
          echo "Please configure passwordless sudo first, then re-run this workflow"

      - name: Apply Ansible changes
        if: steps.test_sudo.outputs.sudo_works == 'true'
        env:
          BD_WEB_HOST: ${{ secrets.PRODUCTION_HOST }}
          ANSIBLE_HOST_KEY_CHECKING: False
        run: |
          cd ansible
          echo "üöÄ Applying Ansible changes..."
          
          ROLES="${{ inputs.roles }}"
          if [ "$ROLES" = "all" ] || [ -z "$ROLES" ]; then
            echo "Running all roles..."
            ansible-playbook -i inventory/production.yml playbooks/initial-setup.yml \
              -e "ansible_user=deploy" \
              --become \
              -v
          else
            echo "Running roles: $ROLES"
            ansible-playbook -i inventory/production.yml playbooks/initial-setup.yml \
              --tags "$ROLES" \
              -e "ansible_user=deploy" \
              --become \
              -v
          fi
          echo "‚úÖ Ansible changes applied successfully"

      - name: Error - Sudo not configured
        if: steps.test_sudo.outputs.sudo_works == 'false'
        run: |
          echo "‚ùå Cannot proceed - passwordless sudo is not configured"
          echo ""
          echo "To fix this, SSH into your server as root and run:"
          echo "  echo 'deploy ALL=(ALL) NOPASSWD: ALL' | sudo tee /etc/sudoers.d/deploy"
          echo "  sudo chmod 0440 /etc/sudoers.d/deploy"
          echo "  sudo visudo -cf /etc/sudoers.d/deploy  # Verify syntax"
          echo ""
          echo "Then re-run this workflow."
          exit 1

      - name: Verify infrastructure
        if: contains(inputs.roles, 'common') || inputs.roles == 'all' || inputs.roles == ''
        run: |
          echo "üîç Verifying infrastructure changes..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
          set -e
          
          echo ""
          echo "=== Node.js and npm ==="
          node --version || echo "‚ùå Node.js not installed"
          npm --version || echo "‚ùå npm not installed"
          
          echo ""
          echo "=== Docker ==="
          docker --version || echo "‚ùå Docker not installed"
          
          echo ""
          echo "=== System Info ==="
          uname -a
          echo ""
          echo "‚úÖ Infrastructure verification complete"
          ENDSSH

      - name: Upload Ansible logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ansible-logs-${{ github.sha }}
          path: |
            ~/.ansible/
          retention-days: 7
          if-no-files-found: ignore

      - name: Clean up SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key ~/.ssh/config

      - name: Summary
        if: success()
        run: |
          echo "‚úÖ Infrastructure update completed successfully!"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Updated by: ${{ github.actor }}"
          echo "üîß Roles executed: ${{ inputs.roles }}"
