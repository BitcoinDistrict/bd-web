---
- name: Create deploy group
  group:
    name: "{{ app_group }}"
    state: present
  tags: deploy-user

- name: Create deploy user
  user:
    name: "{{ app_user }}"
    group: "{{ app_group }}"
    groups: docker,sudo
    shell: /bin/bash
    create_home: yes
    home: "/home/{{ app_user }}"
  tags: deploy-user

- name: Create .ssh directory for deploy user
  file:
    path: "/home/{{ app_user }}/.ssh"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0700'
  tags: deploy-user

- name: Create authorized_keys file for deploy user
  file:
    path: "/home/{{ app_user }}/.ssh/authorized_keys"
    state: touch
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0600'
  tags: deploy-user

- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  tags: deploy-user

- name: Configure passwordless sudo for deploy user
  copy:
    dest: /etc/sudoers.d/deploy
    content: |
      # Full passwordless sudo for Ansible and infrastructure management
      {{ app_user }} ALL=(ALL) NOPASSWD: ALL
    mode: '0440'
    validate: 'visudo -cf %s'
  tags: deploy-user

- name: Create data directories on volume
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default(app_user) }}"
    group: "{{ item.group | default(app_group) }}"
    mode: "{{ item.mode | default('0755') }}"
  loop:
    - { path: "{{ data_mount }}/postgres", owner: '70', group: '70', mode: '0700' }  # PostgreSQL container runs as postgres user (UID 70)
    - { path: "{{ data_mount }}/directus-uploads", owner: '999', group: '999', mode: '0755' }  # Directus runs as node user (UID 999 in v11)
    - { path: "{{ data_mount }}/caddy-data", mode: '0755' }
  tags: deploy-user

- name: Install npm dependencies for import script
  command: npm install
  args:
    chdir: "{{ app_dir }}"
  become: yes
  become_user: "{{ app_user }}"
  tags: deploy-user
  when: app_dir is defined

- name: Create cron job for RSS event import
  cron:
    name: "Import RSS events from BitcoinOnly.events"
    user: "{{ app_user }}"
    minute: "{{ rss_import_cron_minute | default('0') }}"
    hour: "{{ rss_import_cron_hour | default('*/6') }}"
    job: "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin NODE_ENV=production cd {{ app_dir }} && /usr/bin/npm run import-events >> {{ app_dir }}/logs/rss-import.log 2>&1"
    state: present
  tags: deploy-user
  when: rss_import_enabled | default(true)

- name: Create logs directory for cron job output
  file:
    path: "{{ app_dir }}/logs"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  tags: deploy-user
  when: app_dir is defined
