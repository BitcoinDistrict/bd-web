---
- name: Create deploy group
  group:
    name: "{{ app_group }}"
    state: present
  tags: deploy-user

- name: Create deploy user
  user:
    name: "{{ app_user }}"
    group: "{{ app_group }}"
    groups: docker,sudo
    shell: /bin/bash
    create_home: yes
    home: "/home/{{ app_user }}"
  tags: deploy-user

- name: Create .ssh directory for deploy user
  file:
    path: "/home/{{ app_user }}/.ssh"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0700'
  tags: deploy-user

- name: Create authorized_keys file for deploy user
  file:
    path: "/home/{{ app_user }}/.ssh/authorized_keys"
    state: touch
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0600'
  tags: deploy-user

- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  tags: deploy-user

- name: Configure passwordless sudo for deploy user for docker and caddy commands
  copy:
    dest: /etc/sudoers.d/deploy
    content: |
      {{ app_user }} ALL=(ALL) NOPASSWD: /usr/bin/docker, /usr/bin/docker-compose, /usr/bin/systemctl restart caddy, /usr/bin/systemctl reload caddy, /usr/bin/systemctl status caddy, /usr/bin/cp, /usr/bin/mkdir, /usr/bin/chown, /usr/bin/chmod, /usr/bin/caddy, /usr/bin/journalctl, /usr/bin/tar, /usr/bin/rm
    mode: '0440'
    validate: 'visudo -cf %s'
  tags: deploy-user

- name: Create data directories on volume
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default(app_user) }}"
    group: "{{ item.group | default(app_group) }}"
    mode: "{{ item.mode | default('0755') }}"
  loop:
    - { path: "{{ data_mount }}/postgres", owner: '70', group: '70', mode: '0700' }  # PostgreSQL container runs as postgres user (UID 70)
    - { path: "{{ data_mount }}/directus-uploads", owner: '999', group: '999', mode: '0755' }  # Directus runs as node user (UID 999 in v11)
    - { path: "{{ data_mount }}/caddy-data", mode: '0755' }
  tags: deploy-user
