---
- name: Initial server setup for Bitcoin District production
  hosts: bd-web
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Display server information
      debug:
        msg: "Setting up {{ inventory_hostname }} at {{ ansible_host }}"

  roles:
    - role: common
      tags: common

    - role: security
      tags: security

    - role: docker
      tags: docker

    - role: deploy-user
      tags: deploy-user

  post_tasks:
    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Display reboot notification
      debug:
        msg: "A reboot is required to complete the installation. Please reboot the server manually."
      when: reboot_required.stat.exists

    - name: Verify Docker is running
      systemd:
        name: docker
        state: started
      check_mode: yes
      register: docker_status

    - name: Display setup completion message
      debug:
        msg: |
          ========================================
          Initial server setup completed!
          
          Next steps:
          1. Generate SSH key for GitHub Actions:
             ssh-keygen -t ed25519 -f deploy_key -C "github-actions-deploy"
          
          2. Add the public key to deploy user:
             ssh root@{{ ansible_host }} "cat >> /home/{{ app_user }}/.ssh/authorized_keys" < deploy_key.pub
          
          3. Add the private key to GitHub Secrets as PRODUCTION_SSH_KEY
          
          4. Configure Cloudflare DNS:
             - Add A record: staging -> {{ ansible_host }}
             - Set proxy status to "DNS only"
          
          5. Deploy your application:
             git push origin main
          ========================================
